# 用户指南

欢迎使用多模态数据合成系统！本指南将帮助你快速上手并充分利用系统的各项功能。

---

## 📖 目录

- [系统介绍](#系统介绍)
- [安装配置](#安装配置)
- [界面导航](#界面导航)
- [功能使用](#功能使用)
- [常见问题](#常见问题)
- [最佳实践](#最佳实践)

---

## 🎯 系统介绍

### 什么是多模态数据合成系统？

这是一个智能数据生成平台，可以：

- 📷 **基于图片**自动生成问答对
- 🎓 **渐进式难度**：从简单到困难逐步提升
- 🤖 **AI 协作**：三个 AI Agent 协同工作保证质量
- ✅ **自动验证**：只保留高质量的数据

### 适用场景

- 为多模态大模型准备训练数据
- 生成图片理解、视觉推理等任务数据
- 创建从简单到复杂的渐进式数据集

---

## 🔧 安装配置

### 第一步：环境准备

确保你的系统已安装：

- Python 3.8 或更高版本
- 足够的磁盘空间（用于存储图片和结果）

### 第二步：初始化项目

```bash
# 1. 进入项目目录
cd multimodal-data-synthesis-system

# 2. 运行初始化脚本
python init_system.py
```

初始化脚本会：
- ✅ 创建必要的目录结构
- ✅ 生成配置文件模板
- ✅ 检查依赖是否完整

### 第三步：配置 API

编辑 `.env` 文件，填入你的 API 信息：

```bash
# 必填：你的 API Key
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx

# 可选：自定义 API 地址（如使用 Qwen-VL）
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1

# 可选：指定模型
LLM_MODEL_NAME=qwen-vl-max
```

**支持的模型：**
- OpenAI: `gpt-4-vision-preview`, `gpt-4o`
- Qwen: `qwen-vl-max`, `qwen-vl-plus`
- 其他兼容 OpenAI API 的多模态模型

### 第四步：安装依赖

```bash
# 使用 pip 安装
pip install -r requirements.txt

# 或使用启动脚本（自动安装）
bash start.sh
```

### 第五步：启动系统

```bash
# 方法1：使用启动脚本
bash start.sh

# 方法2：直接运行
python web_ui.py
```

启动成功后，浏览器访问：`http://localhost:7860`

---

## 🖥️ 界面导航

### 主界面布局

系统分为三个标签页：

#### 1️⃣ 数据合成页面

```
┌─────────────────────────────────────────┐
│         多模态数据合成系统                │
├─────────────────┬───────────────────────┤
│  配置区域        │    结果展示区域         │
│  ├ 图片上传      │    ├ 合成进度          │
│  ├ 任务配置      │    ├ 实时过程          │
│  ├ 参数设置      │    ├ 已验证问答对      │
│  └ 开始按钮      │    └ 导出结果          │
└─────────────────┴───────────────────────┘
```

#### 2️⃣ LLM 配置页面

用于配置：
- API Key 和 Base URL
- 模型名称
- Temperature、Max Tokens 等参数

#### 3️⃣ Prompt 配置页面

可自定义三个 Agent 的 Prompt：
- 提议者（生成问题）
- 求解者（回答问题）
- 验证者（验证答案）

---

## 📝 功能使用

### 任务 1：基础图片问答

**目标**：为一张图片生成 10 个从简单到困难的问答对

#### 步骤详解

1. **上传图片**
   - 点击"上传图片"按钮
   - 选择一张图片（JPG、PNG 等格式）
   - 预览确认图片已上传

2. **配置任务**
   ```
   任务类型：图片问答类
   任务描述：（可选）留空或填写"关于图片内容的深度问答"
   最大迭代次数：10
   初始难度：0.3
   难度递增步长：0.1
   ```

3. **开始合成**
   - 点击"🚀 开始合成"按钮
   - 观察右侧实时过程

4. **查看结果**
   - 每次迭代会显示：
     - 💡 提议者生成的问题和答案
     - 🤔 求解者的预测答案
     - ✅ 验证者的评估结果
   - 通过验证的问答对会显示在"已验证问答对"区域

5. **导出数据**
   - 点击"📥 导出 JSON"按钮
   - 查看导出路径，获取 JSON 文件

#### 预期效果

```
迭代 1 (难度 0.3):
Q: 图片中有什么？
A: 一只橙色的猫坐在沙发上

迭代 5 (难度 0.7):
Q: 根据猫的身体语言，它的情绪状态是什么？
A: 猫呈现放松状态，耳朵自然竖立，尾巴平放...

迭代 10 (难度 1.2):
Q: 分析图片的构图、光影和色彩搭配，评价其艺术价值
A: 图片采用三分法构图，主体位于黄金分割点...
```

### 任务 2：多图比较分析

**目标**：上传多张图片，生成比较类问题

#### 步骤

1. **上传多张图片**
   - 选择 2-4 张相关或不同的图片
   - 例如：不同季节的同一场景

2. **配置任务**
   ```
   任务类型：多图比较类
   任务描述：比较不同图片的场景、物体、氛围等
   最大迭代次数：8
   初始难度：0.4
   ```

3. **执行并查看结果**

#### 预期效果

```
Q1: 这些图片中有哪些共同元素？
Q2: 图片在色调上有什么显著差异？
Q3: 从构图角度比较，哪张图片更具视觉冲击力？为什么？
```

### 任务 3：自定义任务类型

**目标**：创建特定领域的数据集

#### 步骤

1. **选择任务类型**
   - 任务类型选择"自定义"

2. **输入自定义类型**
   ```
   自定义任务类型：医学影像诊断类
   任务描述：基于医学图片，生成诊断相关的问答
   ```

3. **调整 Prompt（可选）**
   - 切换到"Prompt 配置"标签页
   - 修改提议者的系统 Prompt，添加医学专业要求

4. **执行合成**

---

## ⚙️ 参数说明

### 核心参数

| 参数 | 说明 | 推荐值 | 范围 |
|------|------|--------|------|
| **最大迭代次数** | 生成问答对的数量 | 10 | 1-20 |
| **初始难度** | 第一个问题的难度等级 | 0.3 | 0.1-0.5 |
| **难度递增步长** | 每次迭代增加的难度 | 0.1 | 0.05-0.2 |

### LLM 参数

| 参数 | 说明 | 推荐值 |
|------|------|--------|
| **Temperature** | 生成随机性 | 0.7（创造性任务） |
| | | 0.3（事实性任务） |
| **Max Tokens** | 最大生成长度 | 2048 |

### 参数调优建议

**场景 1：快速生成大量简单问题**
```
最大迭代次数：20
初始难度：0.2
难度递增步长：0.05
```

**场景 2：生成少量高难度问题**
```
最大迭代次数：5
初始难度：0.6
难度递增步长：0.15
```

**场景 3：平衡难度分布**
```
最大迭代次数：10
初始难度：0.3
难度递增步长：0.1
```

---

## ❓ 常见问题

### Q1: 启动失败，提示"找不到模块"

**解决方案：**
```bash
# 确保在正确的环境中
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows

# 重新安装依赖
pip install -r requirements.txt
```

### Q2: API 调用失败

**可能原因：**
- API Key 错误或过期
- 网络连接问题
- API 配额不足

**解决方案：**
1. 检查 `.env` 文件中的 `OPENAI_API_KEY`
2. 测试 API 连接：
   ```bash
   curl -H "Authorization: Bearer $OPENAI_API_KEY" \
        https://api.openai.com/v1/models
   ```
3. 查看日志文件：`logs/agents_*.log`

### Q3: 生成的问题质量不高

**优化建议：**

1. **调整 Prompt**
   - 在"Prompt 配置"页面优化提议者的 Prompt
   - 添加更具体的要求和示例

2. **提高初始难度**
   - 将初始难度从 0.3 提升到 0.5

3. **减小难度递增**
   - 将难度递增从 0.1 降到 0.05，让难度提升更平缓

### Q4: 验证通过率太低

**分析：**
- 求解者无法正确回答 → 问题太难
- 验证者标准太严格

**解决方案：**

1. **降低难度递增速度**
   ```
   难度递增步长：0.05（原来 0.1）
   ```

2. **调整验证阈值**
   - 编辑 `config/settings.py`
   - 修改 `VALIDATION_THRESHOLD`（默认 0.8）

### Q5: 如何批量处理多个图片？

**当前版本限制：**
- 每次任务处理 1-4 张图片
- 适合多图比较类任务

**批量处理方案：**
```python
# 创建批处理脚本（见开发指南）
import os
from pathlib import Path

image_dir = Path("your_images")
for image_file in image_dir.glob("*.jpg"):
    # 为每张图片创建独立任务
    ...
```

---

## 💡 最佳实践

### 实践 1：渐进式数据集构建

**目标**：构建从简单到困难的完整数据集

**步骤：**

1. **第一批：基础问题**
   ```
   初始难度：0.2
   迭代次数：5
   ```

2. **第二批：中等难度**
   ```
   初始难度：0.5
   迭代次数：5
   ```

3. **第三批：高难度**
   ```
   初始难度：0.8
   迭代次数：5
   ```

4. **合并结果**
   - 手动合并三批 JSON 文件
   - 获得 15 个不同难度的问答对

### 实践 2：特定领域数据生成

**场景**：生成医学影像数据集

**配置：**

1. **准备专业图片**
   - X 光片、CT 扫描等

2. **自定义任务描述**
   ```
   任务类型：自定义
   自定义类型：医学影像诊断类
   描述：基于医学影像，生成诊断推理相关的问答
   ```

3. **优化 Prompt**
   - 添加医学术语要求
   - 强调诊断准确性

4. **后处理**
   - 人工审核高风险问题
   - 添加免责声明

### 实践 3：数据质量控制

**策略：**

1. **多轮迭代**
   - 第一轮：生成候选数据
   - 第二轮：人工筛选
   - 第三轮：重新生成未通过的

2. **设置严格验证**
   ```python
   # 修改 config/settings.py
   VALIDATION_THRESHOLD = 0.9  # 提高到 0.9
   ```

3. **审核日志**
   - 定期查看 `logs/` 目录
   - 识别常见错误模式

### 实践 4：成本优化

**降低 API 调用成本：**

1. **减少迭代次数**
   - 每次任务 5-8 次迭代
   - 多次任务累积

2. **调整 Max Tokens**
   - 简单任务：1024
   - 复杂任务：2048

3. **使用更便宜的模型**
   - 开发测试：`qwen-vl-plus`
   - 正式生产：`gpt-4-vision-preview`

---

## 📊 数据使用示例

### 导出的 JSON 格式

```json
{
  "task_id": "task_20260101_143000",
  "task_type": "图片问答类",
  "images": [
    {
      "path": "/path/to/image.jpg",
      "filename": "cat.jpg",
      "uploaded_at": "2026-01-01T14:30:00"
    }
  ],
  "qa_pairs": [
    {
      "question": "图片中的主要对象是什么？",
      "answer": "一只橙色的猫",
      "difficulty": 0.3,
      "iteration": 1,
      "created_at": "2026-01-01T14:30:15"
    }
  ],
  "total_iterations": 10,
  "valid_qa_count": 8,
  "completed_at": "2026-01-01T14:35:00"
}
```

### 转换为训练格式

**示例：转换为 JSONL 格式**

```python
import json

# 读取合成结果
with open('outputs/task_xxx.json', 'r') as f:
    data = json.load(f)

# 转换格式
with open('train.jsonl', 'w') as f:
    for qa in data['qa_pairs']:
        item = {
            "image": data['images'][0]['path'],
            "conversations": [
                {"role": "user", "content": qa['question']},
                {"role": "assistant", "content": qa['answer']}
            ]
        }
        f.write(json.dumps(item, ensure_ascii=False) + '\n')
```

---

## 📞 获取帮助

- **查看日志**：`logs/agents_*.log`
- **开发文档**：[DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md)
- **架构文档**：[ARCHITECTURE.md](ARCHITECTURE.md)

---

**祝你使用愉快！🎉**
