# 用户使用指南

> 面向普通用户的安装、配置和使用教程

---

## 🚀 快速开始

### 系统要求

- Python 3.8+
- 8GB 内存（推荐）
- 稳定的网络连接

### 安装步骤

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置环境
cp .env.example .env
# 编辑 .env 文件（见下文）

# 3. 启动服务
python web_ui.py

# 4. 访问界面
# http://localhost:7860
```

---

## ⚙️ 环境配置

### 必需配置

编辑 `.env` 文件，配置 LLM API：

```bash
# LLM API 配置（必填）
LLM_API_KEY=your-api-key-here
LLM_API_BASE=https://api.openai.com/v1
LLM_MODEL=gpt-3.5-turbo
TEMPERATURE=0.1
```

### 常用 API 配置

**OpenAI**
```bash
LLM_API_KEY=sk-...
LLM_API_BASE=https://api.openai.com/v1
LLM_MODEL=gpt-3.5-turbo
```

**DeepSeek**
```bash
LLM_API_KEY=sk-...
LLM_API_BASE=https://api.deepseek.com/v1
LLM_MODEL=deepseek-chat
```

**通义千问**
```bash
LLM_API_KEY=sk-...
LLM_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_MODEL=qwen-turbo
```

**本地模型（Ollama）**
```bash
LLM_API_KEY=ollama
LLM_API_BASE=http://localhost:11434/v1
LLM_MODEL=llama3
```

### 可选配置

```bash
# Embedding 模型
EMBEDDING_PROVIDER=huggingface
EMBEDDING_MODEL_NAME=BAAI/bge-small-zh-v1.5

# 对话历史轮数
MAX_HISTORY_TURNS=10

# Web 搜索（可选）
ENABLE_WEB_SEARCH=false
WEB_SEARCH_API_KEY=your-search-api-key
```

---

## 📖 使用教程

### 步骤 1：初始化系统

1. 打开 http://localhost:7860
2. 切换到「⚙️ 系统设置」标签页
3. 点击「🔄 初始化系统」
4. 等待初始化完成

### 步骤 2：注册数据源

切换到「🗄️ 数据源管理」标签页

#### 注册数据库

```
数据库名称: sales_db
数据库路径: data/databases/sales.db
```

点击「➕ 注册数据库」

#### 注册文件

```
文件名称: sales_data
文件路径: data/files/sales.csv
```

支持：CSV、Excel、JSON、Parquet

#### 注册知识库

1. 将文档放入 `data/knowledge_base/`
2. 输入知识库名称
3. 点击「➕ 注册知识库」

支持：PDF、Word、Markdown、TXT

#### 启用 Web 搜索

配置 `.env` 后点击「🔌 启用Web搜索」

### 步骤 3：数据分析

切换到「💬 对话分析」标签页

#### 示例查询

**数据库查询**
```
- 统计每个月的销售总额
- 找出销售额前10的产品
- 分析2024年的销售趋势
```

**文件分析**
```
- 这个数据集有多少行？
- 分析各列的数据分布
- 找出price列的异常值
```

**知识库问答**
```
- 公司的休假政策是什么？
- 如何申请报销？
```

#### 多轮对话

```
用户: 查询销售数据
助手: [展示数据]

用户: 按地区分组
助手: [理解上下文，重新查询]

用户: 只看前5名
助手: [继续基于上下文]
```

### 步骤 4：数据可视化

1. 在「对话分析」中执行查询
2. 切换到「📊 数据可视化」标签页
3. 点击「🔄 加载数据」
4. 配置图表：
   - 选择图表类型
   - 选择 X 轴和 Y 轴
   - 可选：颜色分组
5. 点击「🎨 生成图表」

#### 图表类型选择

| 图表 | 适用场景 |
|------|---------|
| 柱状图 | 分类对比 |
| 折线图 | 趋势分析 |
| 散点图 | 相关性分析 |
| 饼图 | 占比分析 |
| 面积图 | 累积趋势 |
| 箱线图 | 分布分析 |

---

## 💡 最佳实践

### 提问技巧

✅ **好的问题**
- "查询2024年1-6月各产品的销售额，按金额降序排列"
- "分析sales表中price和quantity的相关性"
- "公司对于年假的规定是怎样的？"

❌ **不好的问题**
- "查一下"（不明确）
- "数据有问题"（没有具体描述）
- "怎么办"（缺少上下文）

### 数据源管理

- 使用有意义的名称
- 定期更新数据
- 备份重要数据

### 性能优化

- 使用快速模型（gpt-3.5-turbo）
- 限制返回数据量（使用 LIMIT）
- 减少历史轮数

---

## ❓ 常见问题

### Q: 初始化失败？

**检查清单**
- [ ] `.env` 文件配置正确
- [ ] API Key 有效
- [ ] 网络连接正常
- [ ] 查看 `logs/` 目录

### Q: SQL 生成不准确？

**解决方案**
- 提供更详细的问题描述
- 使用多轮对话逐步明确
- 检查数据库 schema 是否正确加载

### Q: 知识库没有结果？

**检查项**
- [ ] 文档已放入目录
- [ ] 文档格式支持
- [ ] 索引构建成功
- [ ] 尝试不同问法

### Q: 响应速度慢？

**优化建议**
- 使用更快的模型
- 减少 `MAX_HISTORY_TURNS`
- 限制数据量
- 使用本地 Embedding

### Q: 如何查看调试日志？

日志位置：`logs/ai_data_analyst_YYYY-MM-DD.log`

包含：
- 所有 LLM 调用的 Prompt
- 系统响应
- 错误信息

---

## 📝 示例：完整工作流

### 1. 创建示例数据库

```bash
python data/create_example_db.py
```

### 2. 注册数据源

```
数据库名称: sales_db
数据库路径: data/databases/sales_example.db
```

### 3. 查询分析

```
查询每个月的总销售额，按月份排序
```

### 4. 可视化

- 加载数据
- 图表类型：折线图
- X轴：date
- Y轴：total_revenue
- 生成图表

---

## 🔗 相关文档

- [📖 功能介绍](FEATURES.md) - 了解所有功能
- [💻 开发指南](DEVELOPER_GUIDE.md) - 二次开发
- [📊 可视化指南](VISUALIZATION_GUIDE.md) - 详细的可视化教程

---

## 📞 技术支持

- 提交 Issue 报告问题
- 查看文档获取帮助
- 参与社区讨论

### 第一步：初始化系统

1. 打开 Web 界面
2. 切换到「⚙️ 系统设置」标签页
3. 点击「🔄 初始化系统」按钮
4. 等待初始化完成

看到「✅ 系统初始化成功！」即可进入下一步。

### 第二步：注册数据源

切换到「🗄️ 数据源管理」标签页，根据需要注册不同类型的数据源：

#### 注册 SQLite 数据库

1. 输入数据库名称（例如：`sales_db`）
2. 输入数据库路径（例如：`data/databases/sales.db`）
3. 点击「➕ 注册数据库」
4. 查看返回的数据库结构信息

**示例**：
```
数据库名称：sales_db
数据库路径：/Users/username/data/sales.db
```

#### 注册文件数据源

支持的文件格式：CSV、Excel、JSON、Parquet

1. 输入文件名称（例如：`sales_data`）
2. 输入文件路径（例如：`data/files/sales.csv`）
3. 点击「➕ 注册文件」
4. 查看文件的列信息和样例数据

#### 注册知识库

1. 将文档放入 `data/knowledge_base/` 目录
2. 输入知识库名称（例如：`company_kb`）
3. 知识库目录留空（使用默认目录）或指定自定义目录
4. 点击「➕ 注册知识库」
5. 等待索引构建完成

**支持的文档格式**：
- PDF、Word、Markdown
- TXT、HTML
- 其他 LlamaIndex 支持的格式

#### 启用 Web 搜索（可选）

1. 在 `.env` 中配置 `WEB_SEARCH_API_KEY`
2. 设置 `ENABLE_WEB_SEARCH=true`
3. 点击「🔌 启用Web搜索」

### 第三步：开始分析

切换到「💬 对话分析」标签页：

#### 基础对话

1. 在「选择数据源」下拉框中选择「无（直接对话）」
2. 输入问题
3. 点击「📤 发送」

**示例问题**：
- "你好，请介绍一下你的功能"
- "什么是NL2SQL？"

#### 单数据源分析

1. 在「选择数据源」中选择已注册的数据源
2. 输入分析问题
3. 查看结果

**示例问题**（针对数据库）：
- "统计每个月的销售总额"
- "找出销售额前10的产品"
- "分析销售趋势"

**示例问题**（针对文件）：
- "这个数据集有多少行？"
- "分析各列的数据分布"
- "找出异常值"

**示例问题**（针对知识库）：
- "公司的休假政策是什么？"
- "如何申请报销？"

#### SQL 查询结果

当进行数据库查询时，系统会自动：
1. 将自然语言转换为 SQL
2. 以语法高亮的方式展示 SQL
3. 执行查询并返回结果
4. 对结果进行分析和解读

**输出示例**：
```markdown
### 生成的SQL查询

​```sql
SELECT 
    DATE_FORMAT(sale_date, '%Y-%m') as month,
    SUM(amount) as total_sales
FROM sales
GROUP BY month
ORDER BY month DESC
​```

### 分析结果

根据查询结果，2023年的销售数据显示：
- 12月销售额最高，达到 ¥850万
- 全年销售呈上升趋势
- ...
```

#### 多轮对话

系统会记住对话上下文，支持连续提问：

```
👤 用户：查询销售数据
🤖 助手：[展示销售数据]

👤 用户：按地区分组
🤖 助手：[理解上下文，按地区重新查询]

👤 用户：只看华东地区
🤖 助手：[继续基于上下文筛选]
```

### 高级功能

#### 多数据源融合分析

目前通过在提问中明确指定多个数据源来实现：

```
"结合 sales_db 数据库和 company_kb 知识库，
分析销售策略的执行效果"
```

#### 生成分析报告

在问题中明确要求生成报告：

```
"分析 sales_data 的销售情况，
生成一份包含摘要、详细分析和建议的报告"
```

#### 决策支持

```
"基于 sales_db 的数据，
应该在哪个地区加大投入？
给出数据支持和行动计划"
```

## 常见问题

### Q1：初始化失败怎么办？

**检查项**：
1. `.env` 文件是否正确配置
2. `LLM_API_KEY` 是否有效
3. 网络连接是否正常
4. 查看 `logs/` 目录下的错误日志

### Q2：SQL 生成不准确？

**解决方案**：
1. 确保数据库 schema 已正确加载
2. 提供更详细的问题描述
3. 尝试多轮对话逐步明确需求
4. 查看日志中的 Prompt，了解 LLM 的理解

### Q3：知识库查询没有结果？

**检查项**：
1. 知识库目录是否包含文档
2. 文档格式是否支持
3. 索引是否构建成功
4. 尝试用不同的问法

### Q4：响应速度慢？

**优化建议**：
1. 使用更快的 LLM 模型（如 gpt-3.5-turbo）
2. 减少历史轮数（`MAX_HISTORY_TURNS`）
3. 限制返回的数据量
4. 使用本地 Embedding 模型

### Q5：如何查看调试信息？

所有 LLM 调用的 Prompt 都会记录在日志中：
- 位置：`logs/ai_data_analyst_YYYY-MM-DD.log`
- 包含：输入 Prompt、LLM 响应、错误信息
- 用于 Debug 和优化 Prompt

## 最佳实践

### 提问技巧

1. **具体明确**：清楚说明要查询的字段、时间范围、筛选条件
2. **分步骤**：复杂分析可以分多轮完成
3. **确认理解**：不确定时可以要求系统解释
4. **提供上下文**：在多轮对话中，适当引用之前的结果

### 数据源管理

1. **命名规范**：使用有意义的数据源名称
2. **定期更新**：及时更新数据库和文件
3. **知识库维护**：定期添加新文档，删除过时内容
4. **备份数据**：重要数据定期备份

### 性能优化

1. **限制数据量**：大数据集先采样或聚合
2. **缓存结果**：相同查询可以重用结果
3. **批量处理**：相关的多个问题可以合并
4. **选择合适的模型**：根据任务复杂度选择模型

## 更新日志

查看项目的 Git 提交历史或 CHANGELOG.md 文件。

## 技术支持

- 查看[开发指南](DEVELOPER_GUIDE.md)了解技术细节
- 查看[功能介绍](FEATURES.md)了解完整功能
- 提交 Issue 报告问题或建议
